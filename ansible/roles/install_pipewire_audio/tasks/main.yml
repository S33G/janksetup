---
- name: Check if user is lingering
  ansible.builtin.stat:
    path: "/var/lib/systemd/linger/ripple"
  register: user_lingering

- name: Enable lingering is needed
  ansible.builtin.command: "loginctl enable-linger ripple"
  when: not user_lingering.stat.exists
  changed_when: not user_lingering.stat.exists

- name: Install packages
  kewlfft.aur.aur:
    use: yay
    name:
      - pipewire
      - pipewire-audio
      - pipewire-alsa
      - pipewire-pulse
      - pavucontrol
      - python-setuptools
      - python-pexpect

- name: Install wireplumber
  ansible.builtin.expect:
    command: "yay -S --needed --cleanafter wireplumber --nodeps"
    responses:
      (?i)wireplumber and pipewire-media-session are in conflict.*:
        - y
      installation:
        - y
    creates: /usr/bin/wireplumber
